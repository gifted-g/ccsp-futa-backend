# ----------- Build stage -----------
FROM golang:1.22 AS build

WORKDIR /app
# Leverage caching
COPY go.mod go.sum ./
RUN go mod download

# Copy source
COPY . .

# Static build for alpine/distroless
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -ldflags="-s -w" -o server ./cmd/server

# ----------- Runtime stage -----------
# You can switch to gcr.io/distroless/static if you prefer
FROM alpine:3.20

# Create non-root user
RUN addgroup -S app && adduser -S app -G app
USER app

WORKDIR /home/app
COPY --from=build /app/server /home/app/server

# Port from your .env (default 8080)
EXPOSE 8080

# Set minimal envs (override via container/task env)
ENV PORT=8080
ENTRYPOINT ["./server"]
